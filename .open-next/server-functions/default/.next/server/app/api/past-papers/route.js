(()=>{var e={};e.id=442,e.ids=[442],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5069:(e,r,t)=>{"use strict";t.d(r,{L:()=>a,db:()=>i});var s=t(56621);async function a(){return await (0,s.b)()}let i=(0,s.b)()},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},12909:(e,r,t)=>{"use strict";t.d(r,{HW:()=>o,hS:()=>n,rN:()=>u});var s=t(36463),a=t(56621);let i=new Map;async function o(){let e,r=await (0,a.b)(),{data:{session:t},error:o}=await r.auth.getSession();if(o||!t)return null;let n=t.user.id,u=t.user.email||"",p=`user:${n}`,c=i.get(p);if(c&&Date.now()-c.timestamp<6e4)return c.user;let{data:l,error:d}=await r.from("users").select("*").eq("id",n).single();if(l){let{data:t,error:a}=await r.from("users").update({email:u,updated_at:new Date().toISOString()}).eq("id",n).select("*").single();if(a)return s.v.error("Error updating user:",a),null;e=t}else{let{data:t,error:a}=await r.from("users").insert({id:n,email:u,subscription_tier:"FREE",role:"STUDENT",onboarding_completed:!1}).select("*").single();if(a)return s.v.error("Error creating user:",a),null;e=t}if(i.set(p,{user:e,timestamp:Date.now()}),i.size>50){let e=Date.now();for(let[r,t]of i.entries())e-t.timestamp>6e4&&i.delete(r)}return e}async function n(e){let r=await (0,a.b)(),{data:t}=await r.rpc("is_feature_active",{flag_name:"summer_promotion_2024"}),{data:i,error:o}=await r.from("users").select("*").eq("id",e).single();if(o||!i)return{canUse:!1,usedToday:0,limit:0};let n=new Date;n.setHours(0,0,0,0);let u=n.toISOString().split("T")[0],{data:p}=await r.from("usage_tracking").select("*").eq("user_id",e).eq("date",u).single(),c=p;if(!p){let{data:e,error:t}=await r.from("usage_tracking").insert({user_id:i.id,date:u,api_calls_used:0,tier:i.subscription_tier}).select("*").single();if(t)return s.v.error("Error creating usage tracking:",t),{canUse:!1,usedToday:0,limit:0};c=e}let l=t||"PRO"===i.subscription_tier?parseInt(process.env.PRO_TIER_DAILY_LIMIT||"200"):parseInt(process.env.FREE_TIER_DAILY_LIMIT||"20");return{canUse:(c?.api_calls_used||0)<l,usedToday:c?.api_calls_used||0,limit:l}}async function u(e){let r=await (0,a.b)(),t=new Date;t.setHours(0,0,0,0);let s=t.toISOString().split("T")[0],{data:i}=await r.from("usage_tracking").select("*").eq("user_id",e).eq("date",s).single();if(i)await r.from("usage_tracking").update({api_calls_used:i.api_calls_used+1}).eq("user_id",e).eq("date",s);else{let{data:t}=await r.from("users").select("subscription_tier").eq("id",e).single();await r.from("usage_tracking").insert({user_id:e,date:s,api_calls_used:1,tier:t?.subscription_tier||"FREE"})}}},27910:e=>{"use strict";e.exports=require("stream")},28939:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>q,routeModule:()=>_,serverHooks:()=>x,workAsyncStorage:()=>w,workUnitAsyncStorage:()=>h});var s={};t.r(s),t.d(s,{GET:()=>m,POST:()=>f});var a=t(96559),i=t(48088),o=t(37719),n=t(36463),u=t(32190),p=t(12909),c=t(5069),l=t(72289),d=t(35282);let g=l.Ik({title:l.Yj().min(1,"Title is required"),subject:l.Yj().min(1,"Subject is required"),examBoard:l.Yj().min(1,"Exam board is required"),year:l.ai().int().min(2010).max(2030),questions:l.YO(l.Ik({id:l.Yj(),question:l.Yj(),marks:l.ai().int().positive(),topic:l.Yj().optional(),markScheme:l.Yj().optional()}))});async function m(e){try{let{searchParams:r}=new URL(e.url),t=r.get("subject"),s=r.get("examBoard"),a=r.get("year"),i=parseInt(r.get("page")||"1"),o=parseInt(r.get("limit")||"10"),p=await c.db,l=p.from("past_papers").select("*"),d=p.from("past_papers").select("*",{count:"exact",head:!0});t&&(l=l.eq("subject",t),d=d.eq("subject",t)),s&&(l=l.eq("exam_board",s),d=d.eq("exam_board",s)),a&&(l=l.eq("year",parseInt(a)),d=d.eq("year",parseInt(a))),l=l.order("year",{ascending:!1}).order("title",{ascending:!0}).range((i-1)*o,i*o-1);let[{data:g,error:m},{count:f,error:_}]=await Promise.all([l,d]);if(m||_)return n.v.error("Supabase past papers query error:",m||_),u.NextResponse.json({error:"Failed to fetch past papers"},{status:500});let[{data:w},{data:h},{data:x}]=await Promise.all([p.from("past_papers").select("subject").order("subject",{ascending:!0}),p.from("past_papers").select("exam_board").order("exam_board",{ascending:!0}),p.from("past_papers").select("year").order("year",{ascending:!1})]),q=[...new Set(w?.map(e=>e.subject)||[])],b=[...new Set(h?.map(e=>e.exam_board)||[])],I=[...new Set(x?.map(e=>e.year)||[])];return u.NextResponse.json({pastPapers:g.map(e=>({...e,questions:Array.isArray(e.questions)?e.questions:[]})),pagination:{page:i,limit:o,total:f||0,pages:Math.ceil((f||0)/o)},filters:{subjects:q,examBoards:b,years:I}})}catch(e){return n.v.error("Past papers API error:",e),u.NextResponse.json({error:"Failed to fetch past papers"},{status:500})}}async function f(e){try{let r=await (0,p.HW)();if(!r)return u.NextResponse.json({error:"User not found"},{status:404});if("ADMIN"!==r.role)return u.NextResponse.json({error:"Only administrators can create past papers"},{status:403});let t=await e.json(),s=g.parse(t),a=await c.db,{data:i,error:o}=await a.from("past_papers").insert({title:s.title,subject:s.subject,exam_board:s.examBoard,year:s.year,questions:s.questions}).select("*").single();if(o||!i)return n.v.error("Supabase past paper creation error:",o),u.NextResponse.json({error:"Failed to create past paper"},{status:500});return u.NextResponse.json({success:!0,pastPaper:{...i,questions:Array.isArray(i.questions)?i.questions:[]}})}catch(e){if(e instanceof d.G)return u.NextResponse.json({error:"Invalid request data",details:e.errors},{status:400});return n.v.error("Create past paper error:",e),u.NextResponse.json({error:"Failed to create past paper"},{status:500})}}let _=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/past-papers/route",pathname:"/api/past-papers",filename:"route",bundlePath:"app/api/past-papers/route"},resolvedPagePath:"/home/new_username/Documents/projects/aiamrkerv2/worktrees/claude/src/app/api/past-papers/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:w,workUnitAsyncStorage:h,serverHooks:x}=_;function q(){return(0,o.patchFetch)({workAsyncStorage:w,workUnitAsyncStorage:h})}},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},36463:(e,r,t)=>{"use strict";t.d(r,{v:()=>a});class s{constructor(){this.logLevel=process.env.NEXT_PUBLIC_LOG_LEVEL||"info",this.setupProductionLogging()}static getInstance(){return s.instance||(s.instance=new s),s.instance}shouldLog(e){let r={debug:0,info:1,warn:2,error:3};return r[e]>=r[this.logLevel]}formatMessage(e,r,t){let s=new Date().toISOString(),a=t?` ${JSON.stringify(t)}`:"";return`[${s}] [${e.toUpperCase()}] ${r}${a}`}async setupProductionLogging(){try{let{getEnvVar:e}=await Promise.resolve().then(t.bind(t,43294)),r=await e("LOGGING_SERVICE");if("sentry"===r)await e("SENTRY_DSN")&&console.warn("Sentry logging not available in Cloudflare Workers environment");else if("logflare"===r){let r=await e("LOGFLARE_API_KEY"),t=await e("LOGFLARE_SOURCE_ID");r&&t&&console.warn("Winston-Logflare logging not available in Cloudflare Workers environment")}else if("datadog"===r){let r=await e("DATADOG_API_KEY");if(r){let{datadogLogs:e}=await t.e(6666).then(t.bind(t,96666));e.init({clientToken:r,site:"datadoghq.com",forwardErrorsToLogs:!0}),this.productionLogger=e}}}catch(e){console.error("Failed to initialize production logging:",e)}}debug(e,r){this.shouldLog("debug")&&console.debug(this.formatMessage("debug",e,r))}info(e,r){this.shouldLog("info")&&(console.info(this.formatMessage("info",e,r)),this.productionLogger&&(this.productionLogger.captureMessage?this.productionLogger.captureMessage(e,"info",r):this.productionLogger.logger&&this.productionLogger.logger.info(e,r)))}warn(e,r){this.shouldLog("warn")&&(console.warn(this.formatMessage("warn",e,r)),this.productionLogger&&(this.productionLogger.captureMessage?this.productionLogger.captureMessage(e,"warning",r):this.productionLogger.logger&&this.productionLogger.logger.warn(e,r)))}error(e,r,t){if(this.shouldLog("error")){let s=r?{error:r.message||r,stack:r.stack}:{};console.error(this.formatMessage("error",e,{...t,...s})),this.productionLogger&&(this.productionLogger.captureException?this.productionLogger.captureException(r||Error(e),{contexts:{context:t}}):this.productionLogger.logger&&this.productionLogger.logger.error(e,{...t,...s}))}}}let a=s.getInstance()},39727:()=>{},43294:(e,r,t)=>{"use strict";t.d(r,{getEnvVar:()=>i});var s=t(62426);async function a(){try{return(await (0,s.DM)()).env}catch(e){return process.env}}async function i(e){return(await a())[e]}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},56621:(e,r,t)=>{"use strict";t.d(r,{b:()=>o});var s=t(66437),a=t(43294);let i=null;async function o(){if(!i){let e=await (0,a.getEnvVar)("NEXT_PUBLIC_SUPABASE_URL"),r=await (0,a.getEnvVar)("NEXT_PUBLIC_SUPABASE_ANON_KEY");if(!e||!r)throw Error("Missing Supabase configuration");i=(0,s.UU)(e,r)}return i}(0,s.UU)("https://tqlnqqrrpzmdpgijxiqk.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxbG5xcXJycHptZHBnaWp4aXFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExMTUwNjAsImV4cCI6MjA2NjY5MTA2MH0.ZDCY7DSswAgcUHFlDl3S0BDDXpX3qmyViWXsIGFhwkw")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4243,2822,580,2289],()=>t(28939));module.exports=s})();