(()=>{var e={};e.id=3424,e.ids=[3424],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5069:(e,r,t)=>{"use strict";t.d(r,{L:()=>i,db:()=>a});var s=t(56621);async function i(){return await (0,s.b)()}let a=(0,s.b)()},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},12909:(e,r,t)=>{"use strict";t.d(r,{HW:()=>o,hS:()=>n,rN:()=>u});var s=t(36463),i=t(56621);let a=new Map;async function o(){let e,r=await (0,i.b)(),{data:{session:t},error:o}=await r.auth.getSession();if(o||!t)return null;let n=t.user.id,u=t.user.email||"",c=`user:${n}`,p=a.get(c);if(p&&Date.now()-p.timestamp<6e4)return p.user;let{data:l,error:d}=await r.from("users").select("*").eq("id",n).single();if(l){let{data:t,error:i}=await r.from("users").update({email:u,updated_at:new Date().toISOString()}).eq("id",n).select("*").single();if(i)return s.v.error("Error updating user:",i),null;e=t}else{let{data:t,error:i}=await r.from("users").insert({id:n,email:u,subscription_tier:"FREE",role:"STUDENT",onboarding_completed:!1}).select("*").single();if(i)return s.v.error("Error creating user:",i),null;e=t}if(a.set(c,{user:e,timestamp:Date.now()}),a.size>50){let e=Date.now();for(let[r,t]of a.entries())e-t.timestamp>6e4&&a.delete(r)}return e}async function n(e){let r=await (0,i.b)(),{data:t}=await r.rpc("is_feature_active",{flag_name:"summer_promotion_2024"}),{data:a,error:o}=await r.from("users").select("*").eq("id",e).single();if(o||!a)return{canUse:!1,usedToday:0,limit:0};let n=new Date;n.setHours(0,0,0,0);let u=n.toISOString().split("T")[0],{data:c}=await r.from("usage_tracking").select("*").eq("user_id",e).eq("date",u).single(),p=c;if(!c){let{data:e,error:t}=await r.from("usage_tracking").insert({user_id:a.id,date:u,api_calls_used:0,tier:a.subscription_tier}).select("*").single();if(t)return s.v.error("Error creating usage tracking:",t),{canUse:!1,usedToday:0,limit:0};p=e}let l=t||"PRO"===a.subscription_tier?parseInt(process.env.PRO_TIER_DAILY_LIMIT||"200"):parseInt(process.env.FREE_TIER_DAILY_LIMIT||"20");return{canUse:(p?.api_calls_used||0)<l,usedToday:p?.api_calls_used||0,limit:l}}async function u(e){let r=await (0,i.b)(),t=new Date;t.setHours(0,0,0,0);let s=t.toISOString().split("T")[0],{data:a}=await r.from("usage_tracking").select("*").eq("user_id",e).eq("date",s).single();if(a)await r.from("usage_tracking").update({api_calls_used:a.api_calls_used+1}).eq("user_id",e).eq("date",s);else{let{data:t}=await r.from("users").select("subscription_tier").eq("id",e).single();await r.from("usage_tracking").insert({user_id:e,date:s,api_calls_used:1,tier:t?.subscription_tier||"FREE"})}}},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},36463:(e,r,t)=>{"use strict";t.d(r,{v:()=>i});class s{constructor(){this.logLevel=process.env.NEXT_PUBLIC_LOG_LEVEL||"info",this.setupProductionLogging()}static getInstance(){return s.instance||(s.instance=new s),s.instance}shouldLog(e){let r={debug:0,info:1,warn:2,error:3};return r[e]>=r[this.logLevel]}formatMessage(e,r,t){let s=new Date().toISOString(),i=t?` ${JSON.stringify(t)}`:"";return`[${s}] [${e.toUpperCase()}] ${r}${i}`}async setupProductionLogging(){try{let{getEnvVar:e}=await Promise.resolve().then(t.bind(t,43294)),r=await e("LOGGING_SERVICE");if("sentry"===r)await e("SENTRY_DSN")&&console.warn("Sentry logging not available in Cloudflare Workers environment");else if("logflare"===r){let r=await e("LOGFLARE_API_KEY"),t=await e("LOGFLARE_SOURCE_ID");r&&t&&console.warn("Winston-Logflare logging not available in Cloudflare Workers environment")}else if("datadog"===r){let r=await e("DATADOG_API_KEY");if(r){let{datadogLogs:e}=await t.e(6666).then(t.bind(t,96666));e.init({clientToken:r,site:"datadoghq.com",forwardErrorsToLogs:!0}),this.productionLogger=e}}}catch(e){console.error("Failed to initialize production logging:",e)}}debug(e,r){this.shouldLog("debug")&&console.debug(this.formatMessage("debug",e,r))}info(e,r){this.shouldLog("info")&&(console.info(this.formatMessage("info",e,r)),this.productionLogger&&(this.productionLogger.captureMessage?this.productionLogger.captureMessage(e,"info",r):this.productionLogger.logger&&this.productionLogger.logger.info(e,r)))}warn(e,r){this.shouldLog("warn")&&(console.warn(this.formatMessage("warn",e,r)),this.productionLogger&&(this.productionLogger.captureMessage?this.productionLogger.captureMessage(e,"warning",r):this.productionLogger.logger&&this.productionLogger.logger.warn(e,r)))}error(e,r,t){if(this.shouldLog("error")){let s=r?{error:r.message||r,stack:r.stack}:{};console.error(this.formatMessage("error",e,{...t,...s})),this.productionLogger&&(this.productionLogger.captureException?this.productionLogger.captureException(r||Error(e),{contexts:{context:t}}):this.productionLogger.logger&&this.productionLogger.logger.error(e,{...t,...s}))}}}let i=s.getInstance()},39727:()=>{},43294:(e,r,t)=>{"use strict";t.d(r,{getEnvVar:()=>a});var s=t(62426);async function i(){try{return(await (0,s.DM)()).env}catch(e){return process.env}}async function a(e){return(await i())[e]}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},56621:(e,r,t)=>{"use strict";t.d(r,{b:()=>o});var s=t(66437),i=t(43294);let a=null;async function o(){if(!a){let e=await (0,i.getEnvVar)("NEXT_PUBLIC_SUPABASE_URL"),r=await (0,i.getEnvVar)("NEXT_PUBLIC_SUPABASE_ANON_KEY");if(!e||!r)throw Error("Missing Supabase configuration");a=(0,s.UU)(e,r)}return a}(0,s.UU)("https://tqlnqqrrpzmdpgijxiqk.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxbG5xcXJycHptZHBnaWp4aXFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExMTUwNjAsImV4cCI6MjA2NjY5MTA2MH0.ZDCY7DSswAgcUHFlDl3S0BDDXpX3qmyViWXsIGFhwkw")},59182:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>_,routeModule:()=>g,serverHooks:()=>m,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>w});var s={};t.r(s),t.d(s,{GET:()=>l,POST:()=>d});var i=t(96559),a=t(48088),o=t(37719),n=t(36463),u=t(32190),c=t(12909),p=t(5069);async function l(e,{params:r}){try{let e=await r,t=await p.db,{data:s,error:i}=await t.from("past_papers").select("*").eq("id",e.id).single();if(i||!s)return u.NextResponse.json({error:"Past paper not found"},{status:404});return u.NextResponse.json({...s,questions:Array.isArray(s.questions)?s.questions:[]})}catch(e){return n.v.error("Past paper fetch error:",e),u.NextResponse.json({error:"Failed to fetch past paper"},{status:500})}}async function d(e,{params:r}){try{let t=await (0,c.HW)();if(!t)return u.NextResponse.json({error:"User not found"},{status:404});let s=await r,i=await p.db,{data:a,error:o}=await i.from("past_papers").select("*").eq("id",s.id).single();if(o||!a)return u.NextResponse.json({error:"Past paper not found"},{status:404});let{answers:l}=await e.json();if(!l||"object"!=typeof l)return u.NextResponse.json({error:"Invalid answers format"},{status:400});let{data:d,error:g}=await i.from("submissions").insert({user_id:t.id,question:`Past Paper: ${a.title}`,answer:JSON.stringify(l),subject:a.subject,exam_board:a.exam_board,marks_total:Array.isArray(a.questions)?a.questions.reduce((e,r)=>e+(r.marks||0),0):0}).select("id, created_at").single();if(g||!d)return n.v.error("Supabase submission creation error:",g),u.NextResponse.json({error:"Failed to create submission"},{status:500});return u.NextResponse.json({success:!0,submission:{id:d.id,createdAt:d.created_at},message:"Past paper submitted successfully"})}catch(e){return n.v.error("Past paper submission error:",e),u.NextResponse.json({error:"Failed to submit past paper"},{status:500})}}let g=new i.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/past-papers/[id]/route",pathname:"/api/past-papers/[id]",filename:"route",bundlePath:"app/api/past-papers/[id]/route"},resolvedPagePath:"/home/new_username/Documents/projects/aiamrkerv2/worktrees/claude/src/app/api/past-papers/[id]/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:f,workUnitAsyncStorage:w,serverHooks:m}=g;function _(){return(0,o.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:w})}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4243,2822,580],()=>t(59182));module.exports=s})();